# 프로젝트 이해 및 개발 계획

## 📋 프로젝트 이해

### 프로젝트 목표
- 블랙박스 영상을 입력받아 교통 위반 이벤트를 자동으로 추출
- 추출된 이벤트를 안전신문고 신고 양식에 맞게 자동 포맷팅하여 출력
- 사용자가 쉽게 신고할 수 있도록 UI 제공

### 기술 스택
- **Frontend**: Streamlit
- **Backend**: FastAPI
- **모델**: 아직 구현되지 않음 → Dummy 데이터로 대체

### 구현할 이벤트 종류
1. 안전거리 미확보
2. 제차 신호 조작 불이행(방향지시등)
3. 적색·황색 신호등에 정지선을 넘는 행위
4. 차선 위반
   - 중앙선 침범
   - 전용차로에 해당하지 않는 차량이 진입하는 행위(bus)

### 출력 양식 (안전신문고 12가지 항목)
1. 자동차·교통 위반 신고 유형
2. 사진/동영상(첨부) - 동영상 1개, 핵심 사진 1장, 차량 crop 1장, 번호판 crop 1장
3. 신고 발생 지역 - GPS 정보 (나중에 구현, 일단 제외)
4. 제목 (LLM으로 생성 가능)
5. 신고 내용 (LLM으로 생성 가능)
6. 차량 번호 (OCR 모델로 추출)
7. 발생 일자
8. 발생 시각
9. 휴대전화 (사용자 입력)
10. 인증번호 (사용자 입력)
11. 신고 내용 공유 (기본값: 아니요)
12. 인적 사항 (사용자 입력)

### UI 설계
- 단일 페이지 또는 여러 신고거리별 개별 페이지 (결정 필요)
- 사용자 입력: 전체 동영상, 사용자 메타 정보
- 출력: 검출된 이벤트들을 아코디언(toggle) 형태로 표시

## 🎯 개발 계획

### 1단계: FastAPI 서버 구조 설계 및 구현
- [ ] FastAPI 메인 앱 설정 (main.py 또는 app.py)
- [ ] API 라우터 구조 설계
  - `/health` - 서버 상태 확인
  - `/upload` - 영상 업로드 및 작업 ID 반환
  - `/tasks/{task_id}/status` - 작업 상태 조회
  - `/tasks/{task_id}/results` - 분석 결과 조회
- [ ] 비동기 작업 처리 구조 (Background Tasks 또는 Celery)
- [ ] 설정 파일 (config.py) 구현
- [ ] 의존성 관리 (dependencies.py) 구현

### 2단계: 데이터 모델 및 스키마 정의
- [ ] Pydantic 스키마 정의 (schemas.py)
  - 영상 업로드 요청/응답
  - 작업 상태 조회 응답
  - 이벤트 검출 결과 스키마
  - 사용자 정보 스키마
- [ ] 데이터베이스 모델 (필요시)
  - 작업 상태 저장
  - 검출 결과 저장

### 3단계: Dummy 이벤트 검출 로직 구현
- [ ] 영상 메타데이터 추출 함수 (발생 시각 계산)
- [ ] Dummy 이벤트 생성 함수
  - dummy_events.json 참고하여 구조 맞추기
  - 4가지 이벤트 타입에 대한 더미 데이터 생성
- [ ] 이벤트 검출 시뮬레이션 로직

### 4단계: 이미지/영상 처리 로직 (Dummy)
- [ ] 핵심 프레임 추출 (Dummy)
- [ ] 차량 Crop 이미지 생성 (Dummy)
- [ ] 번호판 Crop 이미지 생성 (Dummy)
- [ ] 번호판 OCR (Dummy - 더미 번호 반환)
- [ ] 이벤트 구간 영상 클립 생성 (Dummy)

### 5단계: LLM 연동 (선택적)
- [ ] LLM API 키 입력 받기
- [ ] 제목/신고 내용 생성 프롬프트 설계
- [ ] LLM API 호출 함수 (OpenAI, Anthropic 등)
- [ ] 사용자 선택에 따른 LLM 사용 여부 처리

### 6단계: Streamlit UI 구현
- [ ] 메인 페이지 레이아웃
- [ ] 영상 업로드 섹션
- [ ] 사용자 정보 입력 섹션
- [ ] LLM 사용 옵션 UI
- [ ] 분석 결과 표시 (아코디언 형태)
- [ ] 신고 양식 미리보기 및 수정 기능
- [ ] JSON/CSV 다운로드 기능
- [ ] FastAPI 서버와 통신 로직

### 7단계: 통합 및 테스트
- [ ] FastAPI 서버와 Streamlit UI 연동 테스트
- [ ] Dummy 데이터로 전체 플로우 테스트
- [ ] 에러 핸들링 및 예외 처리

## ❓ 개발 전 확인이 필요한 사항

1. **FastAPI 서버 구조**
   - 참고 프로젝트 구조를 그대로 따를지, 아니면 수정이 필요한지?
   - 데이터베이스 사용 여부 (작업 상태 저장이 필요한지?)
A. 참고 프로젝트 구조를 되도록 그대로 따르기. 하지만 수정이 필요하다면 일부 수정은 가능.
A. database를 사용하되, 참고 프로젝트에 있는 것처럼 일단 데이터베이스는 SQLite3, 라이브러리는 SQLModel을 사용하기

2. **비동기 처리 방식**
   - FastAPI Background Tasks 사용할지?
   - Celery 같은 별도 작업 큐가 필요한지?
   - 아니면 동기 처리로 충분한지?
A. background tasks 또는 동기 처리로 하기, 너의 판단 하에 둘 중 하나로 구현하기기

3. **이미지/영상 저장**
   - 업로드된 영상과 생성된 이미지들을 어디에 저장할지?
   - 로컬 파일 시스템? 클라우드 스토리지? 임시 디렉토리?
A. 일단 로컬에 저장되도록 구현, 경로는 너가 적당히 지정하기. 다만 나중에 GCP로 수정할 거니까, 그 코드 부분 표시해 두기.

4. **LLM API**
   - 어떤 LLM API를 사용할 예정인지? (OpenAI, Anthropic, 기타?)
   - 프롬프트 템플릿의 구체적인 내용은?
A. 일단 LLM 세부 로직 부분은 나중에 구현하기, 다만 사용자가 llm을 선택할 수 있게 선택지를 주고 싶음. 

5. **UI 구조**
   - 단일 페이지로 할지, 여러 페이지로 할지 결정이 필요함
A. 단일 페이지로 구현하기, 겉으로 보이는 ui에 대해서는 /data/ephemeral/home/jsw/pro-cv-finalproject-cv-11/frontend/ui_tmp.py를 많이 참고할 것.

6. **모델 통합 계획**
   - 향후 실제 모델을 통합할 때를 대비한 인터페이스 설계가 필요한지?
   - 모델 파일 위치 및 로딩 방식은?
A. 인터페이스 설계가 어떤 걸 의미하는 지 잘 모르겠으나, 너가 판단해서 결정정
A. 모델 파일은 일단 /data/ephemeral/home/jsw/pro-cv-finalproject-cv-11/model에 있다고 가정하고, 어떻게 로드할지는 아직 잘 모르겠다. 다만 /data/ephemeral/home/jsw/cv_serving의 모델 로드 로직과 비슷하지 않을까 생각.

7. **GPS 정보 처리**
   - GPS 정보는 나중에 구현한다고 했지만, 스키마에는 포함시킬지?
A. 응, 그러나 세부 구현은 나중에 달라질 수 있음에 주의.

8. **에러 처리 및 로깅**
   - 로깅 라이브러리 사용 여부 (loguru 등)
   - 에러 응답 형식
A. 너무 과하지 않은 선에서 적당히 loguru로 로깅하기
A. 에러 응답 형식 또한 과하지 않은 선에서 적당히 너가 결정.

