# 최종 개발 계획 (최종본)

## 📌 확정된 사항

### 기술 스택 및 구조
- **Backend**: FastAPI (참고 프로젝트 구조 따름)
- **Frontend**: Streamlit (단일 페이지)
- **Database**: SQLite3 + SQLModel
- **비동기 처리**: Background Tasks
- **로깅**: loguru
- **영상 처리**: opencv-python (cv2)
- **API Prefix**: `/api/v1/`

### 데이터 저장 방식
- **작업 상태**: DB 저장 (Task, Event 테이블)
- **파일 저장**: 로컬 파일 시스템 (경로는 DB에 저장)
- **경로 형식**: **상대 경로 사용** (`./storage/...`)
- **이벤트 ID**: UUID
- **이미지**: 파일로 저장, DB에는 경로만

### LLM 지원
- **선택지**: "사용 안 함", "OpenAI", "Anthropic", "Google"
- **구현**: 스키마만 포함, 실제 구현은 나중에

## 🎯 구체적 구현 사항

### 1. 비디오 파일명 파싱
- **파일명 형식**: `20260115-11h37m24s_N.avi`
- **추출 정보**:
  - 날짜: `20260115` → `2026-01-15`
  - 시간: `11h37m24s` → `11:37:24`
- **예외 처리**: 파일명이 날짜/시간 형식이 아니면 **None 반환** (예외 케이스로 처리)
- **구현 위치**: `utils/video_utils.py` → `extract_datetime_from_filename()`

### 2. 더미 번호판 이미지
- **경로**: `./storage/dummy_plate_images/` (상대 경로)
- **파일**: `plate1.jpg`, `plate2.jpg`, `plate3.jpg`
- **사용 방식**: 이벤트별로 순서대로 할당 (event 1 → plate1, event 2 → plate2, event 3 → plate3)
- **구현 위치**: `services/image_service.py` → `get_dummy_plate_image()`

### 3. 고정된 이벤트 구간
- **이벤트 1**: 1초 ~ 5초
- **이벤트 2**: 6초 ~ 10초
- **이벤트 3**: 11초 ~ 15초
- **핵심 프레임 추출**: 각 구간의 중간 시점
  - 이벤트 1: 3초 (1+5)/2
  - 이벤트 2: 8초 (6+10)/2
  - 이벤트 3: 13초 (11+15)/2
- **구현 위치**: `services/event_service.py` → `detect_dummy_events()`

### 4. 번호판 OCR 하드코딩
- **plate1**: `154러7070`
- **plate2**: `157고4895`
- **plate3**: `120서6041`
- **구현 위치**: `services/image_service.py` → `extract_license_plate_dummy()`

### 5. 위반 이벤트 유형 (0번 항목)
- **안전신문고 양식에 0번 항목 추가**
- **위반 이벤트 유형**: 
  - 안전거리 미확보
  - 제차 신호 조작 불이행(방향지시등)
  - 적색·황색 신호등에 정지선을 넘는 행위
  - 차선 위반 (중앙선 침범 또는 전용차로 진입)
- **구현 위치**: 스키마 및 UI에 0번 항목 추가

## 📁 프로젝트 구조

```
app/
├── main.py                    # FastAPI 앱 진입점
├── config.py                  # 설정 관리 (상대 경로 사용)
├── database.py                # DB 연결 및 모델 (Task, Event)
├── dependencies.py            # 의존성 (모델 로드 등)
├── schemas.py                 # Pydantic 스키마
├── api.py                     # API 라우터
├── services/                  # 비즈니스 로직
│   ├── __init__.py
│   ├── video_service.py       # 영상 처리 서비스
│   ├── event_service.py       # 이벤트 검출 서비스 (고정 구간)
│   ├── image_service.py       # 이미지 처리 서비스 (더미 번호판)
│   └── llm_service.py         # LLM 서비스 (스키마만, 나중에)
├── storage/                  # 파일 저장소 (로컬, 상대 경로)
│   ├── videos/               # 업로드된 원본 영상
│   ├── clips/                # 이벤트 구간 영상 클립
│   └── images/               # 추출된 이미지들
│       ├── key_frames/        # 핵심 프레임
│       ├── vehicle_crops/     # 차량 crop
│       └── license_crops/     # 번호판 crop
└── utils/                    # 유틸리티
    ├── __init__.py
    ├── video_utils.py         # 영상 메타데이터 추출, 파일명 파싱
    └── file_utils.py          # 파일 관리
```

## 🔄 개발 단계별 상세 계획

### Phase 1: 프로젝트 구조 및 기본 설정

#### 1.1 디렉토리 및 파일 생성
- [ ] `app/services/` 디렉토리 생성 및 `__init__.py`
- [ ] `app/utils/` 디렉토리 생성 및 `__init__.py`
- [ ] `app/storage/` 하위 디렉토리 생성 (videos, clips, images/key_frames, images/vehicle_crops, images/license_crops)

#### 1.2 config.py 구현
```python
# 설정 항목 (모두 상대 경로)
- db_url: "sqlite:///./app/db.sqlite3"
- storage_base_path: "./storage"
- dummy_plate_images_path: "./storage/dummy_plate_images"
- model_path: "./model" (향후 사용)
- project_root: Path(__file__).parent.parent  # pro-cv-finalproject-cv-11
```

#### 1.3 dependencies.py 구현
- [ ] 모델 로드 함수 인터페이스 (현재는 더미)
- [ ] `load_model()` 함수
- [ ] `get_model()` 함수

### Phase 2: 데이터베이스 및 스키마

#### 2.1 database.py 구현
```python
# SQLModel 테이블
- Task:
  - id: UUID (PK)
  - status: str (pending/processing/completed/failed)
  - progress: int (0-100)
  - current_step: str
  - video_path: str (상대 경로)
  - user_info: str (JSON 문자열)
  - created_at: datetime
  - updated_at: datetime
  - error_message: str (nullable)

- Event:
  - id: UUID (PK)
  - task_id: UUID (FK)
  - event_type: str (위반 이벤트 유형: 0번 항목)
  - violation_type: str (자동차·교통 위반 신고 유형: 1번 항목)
  - timestamp: str (영상 내 시간)
  - risk_level: str
  - vehicle_number: str
  - location: str (nullable, GPS는 나중에)
  - date: str (nullable, 파일명 파싱 실패 시 None)
  - time: str (nullable, 파일명 파싱 실패 시 None)
  - title: str
  - content: str
  - video_clip_path: str (nullable, 상대 경로)
  - key_frame_path: str (nullable, 상대 경로)
  - vehicle_crop_path: str (nullable, 상대 경로)
  - license_crop_path: str (nullable, 상대 경로)
  - created_at: datetime
```

#### 2.2 schemas.py 구현
```python
# Pydantic 스키마
- UserInfo:
  - phone: str
  - share_content: str (예/아니요)
  - personal_info: str (nullable)
  - llm_provider: str (사용 안 함/OpenAI/Anthropic/Google)
  - llm_api_key: str (nullable)

- UploadRequest:
  - file: UploadFile
  - user_info: UserInfo

- UploadResponse:
  - task_id: UUID

- TaskStatusResponse:
  - status: str
  - progress: int
  - current_step: str
  - error_message: str (nullable)

- EventResponse:
  - event_id: UUID
  - event_type: str (0번: 위반 이벤트 유형)
  - violation_type: str (1번: 자동차·교통 위반 신고 유형)
  - timestamp: str
  - risk_level: str
  - vehicle_number: str
  - location: str (nullable)
  - date: str (nullable)
  - time: str (nullable)
  - title: str
  - content: str
  - video_clip_path: str (nullable)
  - images: dict (key_frame, vehicle_crop, license_plate_crop)

- TaskResultsResponse:
  - task_id: UUID
  - status: str
  - events: List[EventResponse]
```

### Phase 3: FastAPI 서버 구현

#### 3.1 main.py 구현
- [ ] FastAPI 앱 초기화
- [ ] Lifespan 이벤트: DB 테이블 생성, 모델 로드
- [ ] API 라우터 포함
- [ ] CORS 설정 (필요시)

#### 3.2 api.py 구현
- [ ] `GET /health`: 서버 상태 확인
- [ ] `POST /api/v1/upload`: 
  - 파일 저장 (`./storage/videos/`)
  - Task 생성 (status: pending)
  - Background Task 시작
  - task_id 반환 (202 Accepted)
- [ ] `GET /api/v1/tasks/{task_id}/status`: 작업 상태 조회
- [ ] `GET /api/v1/tasks/{task_id}/results`: 분석 결과 조회

#### 3.3 Background Task 함수
- [ ] `process_video_task(task_id: UUID)`: 
  - Task 상태를 processing으로 변경
  - 진행률 업데이트 (10%: 영상 메타데이터 추출)
  - 진행률 업데이트 (30%: 이벤트 검출)
  - 진행률 업데이트 (50%: 이미지 추출)
  - 진행률 업데이트 (70%: 영상 클립 생성)
  - 진행률 업데이트 (90%: 번호판 OCR)
  - 진행률 업데이트 (100%: 완료)
  - Task 상태를 completed로 변경
  - 에러 발생 시 failed로 변경

### Phase 4: 유틸리티 함수 구현

#### 4.1 utils/video_utils.py
- [ ] `extract_datetime_from_filename(filename: str) -> tuple[str | None, str | None]`:
  - 파일명에서 날짜/시간 파싱
  - 형식: `20260115-11h37m24s_N.avi` → `("2026-01-15", "11:37:24")`
  - **예외**: 파싱 실패 시 `(None, None)` 반환 (현재 시간 사용 안 함)
- [ ] `extract_video_metadata(video_path: str) -> dict`:
  - FPS 추출 (cv2)
  - 영상 길이 추출 (cv2)
  - 총 프레임 수 계산
- [ ] `get_frame_at_time(video_path: str, time_seconds: float) -> np.ndarray`:
  - 특정 시간의 프레임 추출

#### 4.2 utils/file_utils.py
- [ ] `save_uploaded_video(file: UploadFile, task_id: UUID) -> str`:
  - 업로드된 영상 저장 (상대 경로)
  - 반환: 저장 경로 (예: `./storage/videos/{task_id}_{filename}`)
- [ ] `create_storage_directories()`:
  - 필요한 디렉토리 생성 (상대 경로 기준)
- [ ] `generate_file_path(task_id: UUID, event_id: UUID, file_type: str) -> str`:
  - 파일 경로 생성 (상대 경로)
  - 예: `./storage/images/key_frames/{task_id}_{event_id}.jpg`

### Phase 5: 서비스 로직 구현

#### 5.1 services/event_service.py
- [ ] `detect_dummy_events(video_path: str, video_date: str | None, video_time: str | None) -> List[dict]`:
  - 고정된 3개 이벤트 구간 생성:
    - 이벤트 1: 1~5초 (중간: 3초)
    - 이벤트 2: 6~10초 (중간: 8초)
    - 이벤트 3: 11~15초 (중간: 13초)
  - 각 이벤트에 발생 시각 계산:
    - `video_date`, `video_time`이 None이면 `date`, `time`도 None으로 설정
    - 그렇지 않으면 비디오 날짜/시간 + 구간 시작 시간 계산
  - 4가지 이벤트 타입 중 랜덤 할당 (0번 항목):
    - 안전거리 미확보
    - 제차 신호 조작 불이행(방향지시등)
    - 적색·황색 신호등에 정지선을 넘는 행위
    - 차선 위반 (중앙선 침범 또는 전용차로 진입)
  - 위반 신고 유형 (1번 항목): "교통위반(교통단속 포함)" 고정
  - 위험도 랜덤 할당 (높음/중간/낮음)
  - 반환: 이벤트 리스트 (event_id는 UUID)

#### 5.2 services/image_service.py
- [ ] `extract_key_frame(video_path: str, time_seconds: float, task_id: UUID, event_id: UUID) -> str`:
  - 특정 시간의 프레임 추출
  - 이미지로 저장 (`./storage/images/key_frames/`)
  - 반환: 저장 경로 (상대 경로)
- [ ] `extract_vehicle_crop(key_frame_path: str, task_id: UUID, event_id: UUID) -> str`:
  - 더미 bounding box로 차량 crop (전체 프레임의 중앙 50% 영역)
  - 저장 (`./storage/images/vehicle_crops/`)
  - 반환: 저장 경로 (상대 경로)
- [ ] `get_dummy_plate_image(event_index: int) -> str`:
  - 이벤트 인덱스에 따라 더미 번호판 이미지 경로 반환 (상대 경로)
  - event_index 0 → `./storage/dummy_plate_images/plate1.jpg`
  - event_index 1 → `./storage/dummy_plate_images/plate2.jpg`
  - event_index 2 → `./storage/dummy_plate_images/plate3.jpg`
- [ ] `extract_license_plate_dummy(event_index: int) -> str`:
  - 하드코딩된 번호판 반환
  - event_index 0 → "154러7070"
  - event_index 1 → "157고4895"
  - event_index 2 → "120서6041"
- [ ] `copy_license_plate_image(plate_image_path: str, task_id: UUID, event_id: UUID) -> str`:
  - 더미 번호판 이미지를 저장소로 복사
  - 저장 (`./storage/images/license_crops/`)
  - 반환: 저장 경로 (상대 경로)

#### 5.3 services/video_service.py
- [ ] `create_video_clip(video_path: str, start_time: float, end_time: float, task_id: UUID, event_id: UUID) -> str`:
  - 이벤트 구간 영상 클립 생성 (cv2 사용)
  - 저장 (`./storage/clips/`)
  - 반환: 저장 경로 (상대 경로)

#### 5.4 services/llm_service.py (스키마만)
- [ ] `generate_title_and_content(event_type: str, violation_type: str, provider: str, api_key: str) -> dict`:
  - 현재는 더미 템플릿 반환
  - 향후 실제 LLM API 호출로 교체
  - 반환: `{"title": "...", "content": "..."}`

### Phase 6: Streamlit UI 구현

#### 6.1 frontend/ui.py 수정
- [ ] 기존 `ui_tmp.py` 참고하여 구조 유지
- [ ] FastAPI 서버 통신 로직 수정
- [ ] API 엔드포인트 업데이트 (`/api/v1/`)

#### 6.2 주요 기능
- [ ] 영상 업로드 섹션
- [ ] 사용자 정보 입력 (휴대전화, 신고 내용 공유, 인적 사항)
- [ ] LLM 선택지 (사용 안 함/OpenAI/Anthropic/Google)
- [ ] 분석 결과 표시 (아코디언)
- [ ] **신고 양식에 0번 항목 추가** (위반 이벤트 유형)
- [ ] 신고 양식 미리보기 및 수정 (0번~12번 항목)
- [ ] JSON/CSV 다운로드

### Phase 7: 통합 및 테스트

#### 7.1 통합 테스트
- [ ] 전체 플로우 테스트 (영상 업로드 → 분석 → 결과 조회)
- [ ] 에러 케이스 테스트
- [ ] 파일명 파싱 테스트 (날짜/시간 포함 vs 예외 케이스)
- [ ] 상대 경로 테스트

#### 7.2 로깅 및 에러 처리
- [ ] 주요 단계 로깅 (loguru)
- [ ] 에러 발생 시 상세 로그
- [ ] 사용자 친화적 에러 메시지

## 🔧 구현 세부사항

### 이벤트 검출 로직
```python
# 고정된 3개 이벤트
EVENT_INTERVALS = [
    (1.0, 5.0),   # 이벤트 1: 1~5초
    (6.0, 10.0),  # 이벤트 2: 6~10초
    (11.0, 15.0)  # 이벤트 3: 11~15초
]

# 핵심 프레임 추출 시간
KEY_FRAME_TIMES = [3.0, 8.0, 13.0]  # 각 구간의 중간

# 번호판 매핑
PLATE_NUMBERS = {
    0: "154러7070",
    1: "157고4895",
    2: "120서6041"
}

# 위반 이벤트 유형 (0번 항목)
EVENT_TYPES = [
    "안전거리 미확보",
    "제차 신호 조작 불이행(방향지시등)",
    "적색·황색 신호등에 정지선을 넘는 행위",
    "차선 위반"
]
```

### 파일명 파싱 로직
```python
# 정규식 패턴
PATTERN = r"(\d{8})-(\d{1,2})h(\d{1,2})m(\d{1,2})s"
# 예: "20260115-11h37m24s_N.avi"
# → 날짜: 2026-01-15, 시간: 11:37:24
# 예외: 파싱 실패 시 (None, None) 반환
```

### 경로 처리
```python
# 모든 경로는 상대 경로로 저장
# 예: "./storage/videos/task_id_filename.avi"
# DB에 저장되는 경로도 상대 경로
# 실제 파일 접근 시 project_root와 결합하여 사용
```

### 안전신문고 양식 구조
```
0. 위반 이벤트 유형: (안전거리 미확보 등)
1. 자동차·교통 위반 신고 유형: (교통위반(교통단속 포함))
2. 사진/동영상(첨부)
3. 신고 발생 지역: (GPS, 나중에)
4. 제목
5. 신고 내용
6. 차량 번호
7. 발생 일자: (파일명 파싱 실패 시 None)
8. 발생 시각: (파일명 파싱 실패 시 None)
9. 휴대전화
10. 인증번호
11. 신고 내용 공유
12. 인적 사항
```

### 진행률 업데이트 단계
- 10%: 영상 메타데이터 추출
- 30%: 이벤트 검출 완료
- 50%: 이미지 추출 완료
- 70%: 영상 클립 생성 완료
- 90%: 번호판 OCR 완료
- 100%: 완료

## 📝 주의사항

1. **상대 경로 사용**
   - 모든 파일 경로는 상대 경로로 저장 (`./storage/...`)
   - DB에 저장되는 경로도 상대 경로
   - 실제 파일 접근 시 `project_root`와 결합
   - 협업 환경에서 경로 문제 방지

2. **파일명 파싱 예외 처리**
   - 날짜/시간 형식이 아니면 `(None, None)` 반환
   - 현재 시간 사용하지 않음
   - DB의 `date`, `time` 필드는 nullable로 처리

3. **0번 항목 추가**
   - 안전신문고 양식에 0번 항목 (위반 이벤트 유형) 추가
   - 스키마, DB, UI 모두에 반영
   - 1번 항목은 "교통위반(교통단속 포함)" 고정

4. **GCP 마이그레이션 준비**
   - 모든 파일 저장 관련 코드에 `# TODO: GCP migration` 주석
   - 스토리지 경로를 config로 관리

5. **모델 통합 대비**
   - Dummy 함수와 실제 함수 교체 가능하도록 인터페이스 설계
   - `services/event_service.py`의 `detect_dummy_events()` → 향후 `detect_events()`로 교체
   - `services/image_service.py`의 더미 함수들 → 실제 모델 함수로 교체

6. **GPS 정보**
   - 스키마에 포함하되, 현재는 null 반환
   - 추후 구현 시 주석으로 표시

7. **LLM 구현**
   - 스키마에만 포함, 실제 API 호출은 나중에
   - 현재는 기본 템플릿으로 제목/내용 생성

8. **에러 처리**
   - 적절한 HTTP 상태 코드 (200, 202, 404, 500 등)
   - 사용자 친화적 에러 메시지

9. **로깅**
   - 주요 작업 단계 로깅 (loguru)
   - 에러 발생 시 상세 로그

## 🚀 개발 시작 준비 완료

모든 사항이 확정되었습니다. 이제 개발을 시작할 수 있습니다!

**개발 순서**:
1. Phase 1: 프로젝트 구조 및 기본 설정
2. Phase 2: 데이터베이스 및 스키마
3. Phase 3: FastAPI 서버 구현
4. Phase 4: 유틸리티 함수 구현
5. Phase 5: 서비스 로직 구현
6. Phase 6: Streamlit UI 구현
7. Phase 7: 통합 및 테스트

**주요 변경사항 요약**:
1. ✅ 파일명 파싱 실패 시 None 반환 (현재 시간 사용 안 함)
2. ✅ 모든 경로를 상대 경로로 변경 (`./storage/...`)
3. ✅ 안전신문고 양식에 0번 항목 추가 (위반 이벤트 유형)

