# μ½”λ“ μ΄ν•΄ κ°€μ΄λ“

μ΄ λ¬Έμ„λ” ν”„λ΅μ νΈ μ½”λ“λ¥Ό μμ„λ€λ΅ μ΄ν•΄ν•κΈ° μ„ν• κ°€μ΄λ“μ…λ‹λ‹¤. ν€μ›μ—κ² μ„¤λ…ν•κΈ° μ „μ— μ΄ μμ„λ€λ΅ νμΌμ„ μ½μΌλ©΄μ„ μ „μ²΄ νλ¦„μ„ νμ•…ν•μ„Έμ”.

## π“ μ½κΈ° μμ„

### 1λ‹¨κ³„: ν”„λ΅μ νΈ κΈ°λ³Έ κµ¬μ΅° μ΄ν•΄

#### 1.1 `config.py` - μ„¤μ • κ΄€λ¦¬
**λ©μ **: ν”„λ΅μ νΈ μ „λ°μ μ„¤μ •κ°’ κ΄€λ¦¬
**ν•µμ‹¬ λ‚΄μ©**:
- λ°μ΄ν„°λ² μ΄μ¤ URL
- μ¤ν† λ¦¬μ§€ κ²½λ΅ (`storage`, `dummy_plate_images`)
- ν”„λ΅μ νΈ λ£¨νΈ κ²½λ΅
- ν™κ²½ λ³€μλ΅ μ¤λ²„λΌμ΄λ“ κ°€λ¥

**ν™•μΈν•  κ²ƒ**:
- `storage_base_path`: νμΌ μ €μ¥ μ„μΉ
- `project_root`: ν”„λ΅μ νΈ λ£¨νΈ κ²½λ΅ κ³„μ‚° λ°©μ‹

---

#### 1.2 `database.py` - λ°μ΄ν„°λ² μ΄μ¤ λ¨λΈ
**λ©μ **: SQLModelμ„ μ‚¬μ©ν• λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§ μ •μ
**ν•µμ‹¬ λ‚΄μ©**:
- `Task` ν…μ΄λΈ”: μ‘μ—… μƒνƒ κ΄€λ¦¬
  - `id`, `status`, `progress`, `current_step`
  - `video_path`, `user_info`, `error_message`
- `Event` ν…μ΄λΈ”: κ²€μ¶λ μ΄λ²¤νΈ μ •λ³΄
  - `event_type` (0λ²: μ„λ° μ΄λ²¤νΈ μ ν•)
  - `violation_type` (1λ²: μλ™μ°¨Β·κµν†µ μ„λ° μ‹ κ³  μ ν•)
  - μ΄λ―Έμ§€/μμƒ κ²½λ΅λ“¤

**ν™•μΈν•  κ²ƒ**:
- κ° ν•„λ“μ μλ―Έμ™€ μ©λ„
- μƒλ€ κ²½λ΅λ΅ μ €μ¥λλ” νμΌ κ²½λ΅λ“¤

---

#### 1.3 `schemas.py` - API μ”μ²­/μ‘λ‹µ μ¤ν‚¤λ§
**λ©μ **: Pydanticμ„ μ‚¬μ©ν• API μ¤ν‚¤λ§ μ •μ
**ν•µμ‹¬ λ‚΄μ©**:
- `UserInfo`: μ‚¬μ©μ μ •λ³΄
- `UploadResponse`: μ—…λ΅λ“ μ‘λ‹µ (task_id)
- `TaskStatusResponse`: μ‘μ—… μƒνƒ μ΅°ν
- `EventResponse`: μ΄λ²¤νΈ μ •λ³΄
- `TaskResultsResponse`: λ¶„μ„ κ²°κ³Ό

**ν™•μΈν•  κ²ƒ**:
- API κ°„ λ°μ΄ν„° μ „λ‹¬ ν•μ‹
- 0λ² ν•­λ© (μ„λ° μ΄λ²¤νΈ μ ν•) ν¬ν•¨ μ—¬λ¶€

---

#### 1.4 `dependencies.py` - μμ΅΄μ„± κ΄€λ¦¬
**λ©μ **: λ¨λΈ λ΅λ“ λ“± κ³µν†µ μμ΅΄μ„± κ΄€λ¦¬
**ν•µμ‹¬ λ‚΄μ©**:
- `load_model()`: λ¨λΈ λ΅λ“ ν•¨μ (ν„μ¬λ” λ”λ―Έ)
- `get_model()`: λ¨λΈ λ°ν™ ν•¨μ

**ν™•μΈν•  κ²ƒ**:
- ν–¥ν›„ μ‹¤μ  λ¨λΈ ν†µν•© μ‹ μμ •ν•  λ¶€λ¶„

---

### 2λ‹¨κ³„: API μ„λ²„ κµ¬μ΅° μ΄ν•΄

#### 2.1 `main.py` - FastAPI μ•± μ§„μ…μ 
**λ©μ **: FastAPI μ• ν”λ¦¬μΌ€μ΄μ… μ΄κΈ°ν™”
**ν•µμ‹¬ λ‚΄μ©**:
- FastAPI μ•± μƒμ„±
- Lifespan μ΄λ²¤νΈ: DB ν…μ΄λΈ” μƒμ„±, λ¨λΈ λ΅λ“
- CORS μ„¤μ •
- API λΌμ°ν„° ν¬ν•¨ (`/api/v1`)

**ν™•μΈν•  κ²ƒ**:
- μ• ν”λ¦¬μΌ€μ΄μ… μ‹μ‘ μ‹ μ‹¤ν–‰λλ” μ‘μ—…
- λΌμ°ν„° λ“±λ΅ λ°©μ‹

---

#### 2.2 `api.py` - API μ—”λ“ν¬μΈνΈ
**λ©μ **: REST API μ—”λ“ν¬μΈνΈ κµ¬ν„
**ν•µμ‹¬ λ‚΄μ©**:
- `POST /api/v1/upload`: μμƒ μ—…λ΅λ“
  - νμΌ μ €μ¥
  - Task μƒμ„±
  - Background Task μ‹μ‘
- `GET /api/v1/tasks/{task_id}/status`: μ‘μ—… μƒνƒ μ΅°ν
- `GET /api/v1/tasks/{task_id}/results`: λ¶„μ„ κ²°κ³Ό μ΅°ν

**ν™•μΈν•  κ²ƒ**:
- μ—…λ΅λ“ ν”λ΅μ°
- Background Task μ‹μ‘ λ°©μ‹
- μ‘λ‹µ ν•μ‹

---

### 3λ‹¨κ³„: μ ν‹Έλ¦¬ν‹° ν•¨μ μ΄ν•΄

#### 3.1 `utils/file_utils.py` - νμΌ κ΄€λ¦¬
**λ©μ **: νμΌ μ €μ¥ λ° κ²½λ΅ μƒμ„±
**ν•µμ‹¬ λ‚΄μ©**:
- `create_storage_directories()`: μ €μ¥μ† λ””λ ‰ν† λ¦¬ μƒμ„±
- `save_uploaded_video()`: μ—…λ΅λ“λ μμƒ μ €μ¥
- `generate_file_path()`: νμΌ κ²½λ΅ μƒμ„± (μƒλ€ κ²½λ΅)

**ν™•μΈν•  κ²ƒ**:
- μƒλ€ κ²½λ΅ μƒμ„± λ°©μ‹ (`storage/...`)
- GCP λ§μ΄κ·Έλ μ΄μ… μ£Όμ„

---

#### 3.2 `utils/video_utils.py` - μμƒ μ²λ¦¬ μ ν‹Έλ¦¬ν‹°
**λ©μ **: μμƒ λ©”νƒ€λ°μ΄ν„° μ¶”μ¶ λ° ν”„λ μ„ μ²λ¦¬
**ν•µμ‹¬ λ‚΄μ©**:
- `extract_datetime_from_filename()`: νμΌλ…μ—μ„ λ‚ μ§/μ‹κ°„ μ¶”μ¶
  - ν•μ‹: `20260115-11h37m24s_N.avi`
  - μ‹¤ν¨ μ‹ `(None, None)` λ°ν™
- `extract_video_metadata()`: FPS, κΈΈμ΄, ν”„λ μ„ μ μ¶”μ¶
- `get_frame_at_time()`: νΉμ • μ‹κ°„μ ν”„λ μ„ μ¶”μ¶

**ν™•μΈν•  κ²ƒ**:
- νμΌλ… νμ‹± λ΅μ§
- μμ™Έ μ²λ¦¬ λ°©μ‹

---

### 4λ‹¨κ³„: μ„λΉ„μ¤ λ΅μ§ μ΄ν•΄

#### 4.1 `services/event_service.py` - μ΄λ²¤νΈ κ²€μ¶
**λ©μ **: λ”λ―Έ μ΄λ²¤νΈ κ²€μ¶ (κ³ μ •λ 3κ° κµ¬κ°„)
**ν•µμ‹¬ λ‚΄μ©**:
- `detect_dummy_events()`: κ³ μ •λ μ΄λ²¤νΈ κµ¬κ°„ μƒμ„±
  - μ΄λ²¤νΈ 1: 1~5μ΄ (ν•µμ‹¬ ν”„λ μ„: 3μ΄)
  - μ΄λ²¤νΈ 2: 6~10μ΄ (ν•µμ‹¬ ν”„λ μ„: 8μ΄)
  - μ΄λ²¤νΈ 3: 11~15μ΄ (ν•µμ‹¬ ν”„λ μ„: 13μ΄)
- 4κ°€μ§€ μ„λ° μ΄λ²¤νΈ μ ν• μ¤‘ λλ¤ ν• λ‹Ή
- λ°μƒ μ‹κ° κ³„μ‚° (νμΌλ… νμ‹± κ²°κ³Ό ν™μ©)

**ν™•μΈν•  κ²ƒ**:
- κ³ μ •λ μ΄λ²¤νΈ κµ¬κ°„
- λ‚ μ§/μ‹κ°„μ΄ NoneμΌ λ• μ²λ¦¬
- ν–¥ν›„ μ‹¤μ  λ¨λΈλ΅ κµμ²΄ν•  λ¶€λ¶„

---

#### 4.2 `services/image_service.py` - μ΄λ―Έμ§€ μ²λ¦¬
**λ©μ **: μ΄λ―Έμ§€ μ¶”μ¶ λ° λ²νΈν μ²λ¦¬
**ν•µμ‹¬ λ‚΄μ©**:
- `extract_key_frame()`: ν•µμ‹¬ ν”„λ μ„ μ¶”μ¶
- `extract_vehicle_crop()`: μ°¨λ‰ Crop (λ”λ―Έ bounding box)
- `get_dummy_plate_image()`: λ”λ―Έ λ²νΈν μ΄λ―Έμ§€ κ²½λ΅ λ°ν™
- `extract_license_plate_dummy()`: λ²νΈν OCR (ν•λ“μ½”λ”©)
  - plate1: "154λ¬7070"
  - plate2: "157κ³ 4895"
  - plate3: "120μ„6041"
- `copy_license_plate_image()`: λ²νΈν μ΄λ―Έμ§€ λ³µμ‚¬

**ν™•μΈν•  κ²ƒ**:
- λ”λ―Έ λ°μ΄ν„° μ‚¬μ© λ°©μ‹
- ν–¥ν›„ μ‹¤μ  λ¨λΈλ΅ κµμ²΄ν•  λ¶€λ¶„

---

#### 4.3 `services/video_service.py` - μμƒ μ²λ¦¬
**λ©μ **: μμƒ ν΄λ¦½ μƒμ„± λ° μ‘μ—… μ²λ¦¬
**ν•µμ‹¬ λ‚΄μ©**:
- `create_video_clip()`: μ΄λ²¤νΈ κµ¬κ°„ μμƒ ν΄λ¦½ μƒμ„±
  - OpenCV VideoWriter μ‚¬μ©
  - μ½”λ±: `mp4v` (ν„μ¬)
- `process_video_task()`: **ν•µμ‹¬ ν•¨μ** - μ „μ²΄ μ‘μ—… μ²λ¦¬
  - μ§„ν–‰λ¥  μ—…λ°μ΄νΈ (10% β†’ 30% β†’ 50% β†’ 70% β†’ 90% β†’ 100%)
  - κ° λ‹¨κ³„λ³„ μ²λ¦¬:
    1. μμƒ λ©”νƒ€λ°μ΄ν„° μ¶”μ¶
    2. μ΄λ²¤νΈ κ²€μ¶
    3. μ΄λ―Έμ§€ μ¶”μ¶
    4. μμƒ ν΄λ¦½ μƒμ„±
    5. λ²νΈν OCR
    6. LLMμΌλ΅ μ λ©/λ‚΄μ© μƒμ„±
    7. Event μ €μ¥

**ν™•μΈν•  κ²ƒ**:
- Background Task μ‹¤ν–‰ νλ¦„
- μ§„ν–‰λ¥  μ—…λ°μ΄νΈ λ°©μ‹
- μ—λ¬ μ²λ¦¬

---

#### 4.4 `services/llm_service.py` - LLM μ„λΉ„μ¤
**λ©μ **: LLMμ„ μ‚¬μ©ν• μ λ©/λ‚΄μ© μƒμ„± (ν„μ¬λ” λ”λ―Έ)
**ν•µμ‹¬ λ‚΄μ©**:
- `generate_title_and_content()`: μ λ©κ³Ό μ‹ κ³  λ‚΄μ© μƒμ„±
- ν„μ¬λ” λ”λ―Έ ν…ν”λ¦Ώ μ‚¬μ©
- ν–¥ν›„ μ‹¤μ  LLM API νΈμ¶λ΅ κµμ²΄ μμ •

**ν™•μΈν•  κ²ƒ**:
- LLM μ κ³µμ μ„ νƒμ§€ (μ‚¬μ© μ• ν•¨/OpenAI/Anthropic/Google)
- ν–¥ν›„ κµ¬ν„ν•  λ¶€λ¶„

---

### 5λ‹¨κ³„: UI μ΄ν•΄

#### 5.1 `ui.py` - Streamlit UI
**λ©μ **: μ‚¬μ©μ μΈν„°νμ΄μ¤
**ν•µμ‹¬ λ‚΄μ©**:
- μμƒ μ—…λ΅λ“ μ„Ήμ…
- μ‚¬μ©μ μ •λ³΄ μ…λ ¥
- LLM μ„ νƒμ§€
- λ¶„μ„ κ²°κ³Ό ν‘μ‹ (μ•„μ½”λ””μ–Έ)
- μ‹ κ³  μ–‘μ‹ (0λ²~12λ² ν•­λ©)
- JSON/CSV λ‹¤μ΄λ΅λ“

**ν™•μΈν•  κ²ƒ**:
- FastAPI μ„λ²„ ν†µμ‹  λ°©μ‹
- μ΄λ²¤νΈ ν‘μ‹ λ°©μ‹
- μ‹ κ³  μ–‘μ‹ ν¬λ§·ν…

---

## π”„ μ „μ²΄ ν”λ΅μ° μ”μ•½

### μ‚¬μ©μ μ”μ²­λ¶€ν„° κ²°κ³Ό λ°ν™κΉμ§€

1. **μ‚¬μ©μ μ•΅μ…** (`ui.py`)
   - μμƒ μ—…λ΅λ“
   - μ‚¬μ©μ μ •λ³΄ μ…λ ¥
   - LLM μ„ νƒ

2. **API μ”μ²­** (`api.py`)
   - `POST /api/v1/upload`
   - νμΌ μ €μ¥ (`file_utils.py`)
   - Task μƒμ„± (`database.py`)
   - Background Task μ‹μ‘

3. **λ°±κ·ΈλΌμ΄λ“ μ²λ¦¬** (`video_service.py` β†’ `process_video_task()`)
   - μμƒ λ©”νƒ€λ°μ΄ν„° μ¶”μ¶ (`video_utils.py`)
   - νμΌλ… νμ‹± (`video_utils.py`)
   - μ΄λ²¤νΈ κ²€μ¶ (`event_service.py`)
   - μ΄λ―Έμ§€ μ¶”μ¶ (`image_service.py`)
   - μμƒ ν΄λ¦½ μƒμ„± (`video_service.py`)
   - λ²νΈν OCR (`image_service.py`)
   - LLM μ λ©/λ‚΄μ© μƒμ„± (`llm_service.py`)
   - Event μ €μ¥ (`database.py`)

4. **μƒνƒ μ΅°ν** (`api.py`)
   - `GET /api/v1/tasks/{task_id}/status`
   - μ§„ν–‰λ¥  ν™•μΈ

5. **κ²°κ³Ό μ΅°ν** (`api.py`)
   - `GET /api/v1/tasks/{task_id}/results`
   - Event λ¦¬μ¤νΈ λ°ν™

6. **UI ν‘μ‹** (`ui.py`)
   - κ²°κ³Όλ¥Ό μ•„μ½”λ””μ–ΈμΌλ΅ ν‘μ‹
   - μ‹ κ³  μ–‘μ‹ λ―Έλ¦¬λ³΄κΈ°
   - λ‹¤μ΄λ΅λ“ κΈ°λ¥

---

## π― ν•µμ‹¬ ν¬μΈνΈ

### 1. μƒλ€ κ²½λ΅ μ‚¬μ©
- λ¨λ“  νμΌ κ²½λ΅λ” `storage/...` ν•μ‹ (μƒλ€ κ²½λ΅)
- DBμ— μ €μ¥λλ” κ²½λ΅λ„ μƒλ€ κ²½λ΅
- μ‹¤μ  νμΌ μ ‘κ·Ό μ‹ `project_root`μ™€ κ²°ν•©

### 2. λ”λ―Έ λ°μ΄ν„° μ‚¬μ©
- μ΄λ²¤νΈ κ²€μ¶: κ³ μ •λ 3κ° κµ¬κ°„
- λ²νΈν OCR: ν•λ“μ½”λ”©λ λ²νΈ
- LLM: λ”λ―Έ ν…ν”λ¦Ώ
- ν–¥ν›„ μ‹¤μ  λ¨λΈλ΅ κµμ²΄ μμ •

### 3. 0λ² ν•­λ©
- μ•μ „μ‹ λ¬Έκ³  μ–‘μ‹μ— 0λ² ν•­λ© μ¶”κ°€ (μ„λ° μ΄λ²¤νΈ μ ν•)
- DB, μ¤ν‚¤λ§, UI λ¨λ‘μ— λ°μ

### 4. Background Tasks
- λΉ„λ™κΈ° μ²λ¦¬λ΅ μ‚¬μ©μ λ€κΈ° μ‹κ°„ μµμ†ν™”
- μ§„ν–‰λ¥  μ‹¤μ‹κ°„ μ—…λ°μ΄νΈ

### 5. GCP λ§μ΄κ·Έλ μ΄μ… μ¤€λΉ„
- νμΌ μ €μ¥ κ΄€λ ¨ μ½”λ“μ— `# TODO: GCP migration` μ£Όμ„
- ν–¥ν›„ ν΄λΌμ°λ“ μ¤ν† λ¦¬μ§€λ΅ λ³€κ²½ μμ •

---

## π“ μ½κΈ° ν

1. **μμ„λ€λ΅ μ½κΈ°**: μ„ μμ„λ€λ΅ μ½μΌλ©΄ μμ—°μ¤λ½κ² νλ¦„ νμ•… κ°€λ¥
2. **ν•¨μλ… μ¤‘μ‹¬**: ν•¨μλ…μ΄ μ—­ν• μ„ μ μ„¤λ…ν•¨
3. **μ£Όμ„ ν™•μΈ**: `# TODO` μ£Όμ„μΌλ΅ ν–¥ν›„ μ‘μ—… ν™•μΈ
4. **μ—λ¬ μ²λ¦¬**: `try-except` λΈ”λ΅μΌλ΅ μ—λ¬ μ²λ¦¬ λ°©μ‹ ν™•μΈ
5. **λ΅κΉ…**: `logger` μ‚¬μ©μΌλ΅ μ£Όμ” λ‹¨κ³„ μ¶”μ 

---

## β“ μ΄ν•΄ ν™•μΈ μ²΄ν¬λ¦¬μ¤νΈ

κ° λ‹¨κ³„λ¥Ό μ½μ€ ν›„ λ‹¤μμ„ ν™•μΈν•μ„Έμ”:

- [ ] μ„¤μ •κ°’λ“¤μ΄ μ–΄λ””μ„ μ‚¬μ©λλ”μ§€ μ΄ν•΄ν–λ”κ°€?
- [ ] λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§ κµ¬μ΅°λ¥Ό μ΄ν•΄ν–λ”κ°€?
- [ ] API μ—”λ“ν¬μΈνΈμ μ—­ν• μ„ μ΄ν•΄ν–λ”κ°€?
- [ ] Background Taskκ°€ μ–΄λ–»κ² λ™μ‘ν•λ”μ§€ μ΄ν•΄ν–λ”κ°€?
- [ ] μ΄λ²¤νΈ κ²€μ¶ λ΅μ§μ„ μ΄ν•΄ν–λ”κ°€?
- [ ] μ΄λ―Έμ§€/μμƒ μ²λ¦¬ λ°©μ‹μ„ μ΄ν•΄ν–λ”κ°€?
- [ ] UIμ™€ μ„λ²„ κ°„ ν†µμ‹  λ°©μ‹μ„ μ΄ν•΄ν–λ”κ°€?
- [ ] μ „μ²΄ ν”λ΅μ°λ¥Ό μ„¤λ…ν•  μ μλ”κ°€?

---

## π€ λ‹¤μ λ‹¨κ³„

μ½”λ“λ¥Ό μ΄ν•΄ν• ν›„:
1. ν€μ›μ—κ² μ„¤λ…ν•  λ°ν‘ μλ£ μ¤€λΉ„
2. κ° λ¨λ“μ μ—­ν• κ³Ό μ±…μ„ μ •λ¦¬
3. ν–¥ν›„ κ°μ„  μ‚¬ν•­ μ •λ¦¬
4. μ‹¤μ  λ¨λΈ ν†µν•© κ³„ν μλ¦½

